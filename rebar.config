%% NOTE: Order of the deps matters!
{elixir_deps, []}.

{project_app_dirs, ["emqx", "emqx/apps/*"]}.

{deps, [ ]}.

%% Added to deps list for 'cloud' profile
{cloud_deps, [ ]}.

{edge_deps, []}.

{relx,
 [{include_src, false},
  {extended_start_script, false},
  {generate_start_script, false},
  {sys_config, false},
  {vm_args, false},
  {release, {emqx, git_describe},
   [kernel,
    sasl,
    crypto,
    public_key,
    asn1,
    syntax_tools,
    ssl,
    os_mon,
    inets,
    compiler,
    runtime_tools,
    cuttlefish,
    emqx,
    {mnesia, load},
    {ekka, load},
    {emqx_retainer, load},
    {emqx_management, load},
    {emqx_dashboard, load},
    {emqx_bridge_mqtt, load},
    {emqx_sn, load},
    {emqx_coap, load},
    {emqx_stomp, load},
    {emqx_auth_http, load},
    {emqx_auth_mysql, load},
    {emqx_auth_jwt, load},
    {emqx_auth_mnesia, load},
    {emqx_web_hook, load},
    {emqx_recon, load},
    {emqx_rule_engine, load},
    {emqx_sasl, load},
    {emqx_telemetry, load}
   ]},
  {overlay,
   [{mkdir,"etc/"},
    {mkdir,"etc/plugins"},
    {mkdir,"log/"},
    {mkdir,"data/"},
    {mkdir,"data/mnesia"},
    {mkdir,"data/configs"},
    {mkdir,"data/scripts"},
    {template,"data/emqx_vars","releases/emqx_vars"},
    {template,"bin/emqx_env","bin/emqx_env"},
    {copy,"bin/emqx","bin/emqx"},
    {copy,"bin/emqx_ctl","bin/emqx_ctl"},
    {copy,"bin/install_upgrade.escript", "bin/install_upgrade.escript"},
    {copy,"bin/emqx","bin/emqx-{{ release_version }}"}, %% for relup
    {copy,"bin/emqx_ctl","bin/emqx_ctl-{{ release_version }}"}, %% for relup
    {copy,"bin/install_upgrade.escript", "bin/install_upgrade.escript-{{ release_version }}"}, %% for relup
    {template,"bin/emqx.cmd","bin/emqx.cmd"},
    {template,"bin/emqx_ctl.cmd","bin/emqx_ctl.cmd"},
    {template,"{{output_dir}}/../../lib/emqx/etc/emqx.conf","etc/emqx.conf"},
    {template,"{{output_dir}}/../../lib/emqx/etc/ssl_dist.conf","etc/ssl_dist.conf"},
    {template,"{{output_dir}}/../../lib/emqx_bridge_mqtt/etc/emqx_bridge_mqtt.conf", "etc/plugins/emqx_bridge_mqtt.conf"},
    {template,"{{output_dir}}/../../lib/emqx_coap/etc/emqx_coap.conf", "etc/plugins/emqx_coap.conf"},
    {template,"{{output_dir}}/../../lib/emqx_auth_http/etc/emqx_auth_http.conf", "etc/plugins/emqx_auth_http.conf"},
    {template, "data/loaded_plugins.tmpl", "data/loaded_plugins"},
    {template, "data/loaded_modules.tmpl", "data/loaded_modules"},
    {copy,"{{output_dir}}/../../lib/emqx/etc/acl.conf","etc/acl.conf"},
    {copy,"bin/nodetool","bin/nodetool"},
    {copy,"bin/nodetool","bin/nodetool-{{ release_version }}"},
    {copy,"{{output_dir}}/../../lib/emqx/priv/emqx.schema","releases/{{ release_version }}/"},
    {template,"{{output_dir}}/../../lib/emqx/etc/{{vm_args_file}}","etc/vm.args"},
    {copy, "{{output_dir}}/../../lib/emqx/etc/certs","etc/"},
    {copy, "{{output_dir}}/../../lib/cuttlefish/cuttlefish","bin/"},
    {copy, "{{output_dir}}/../../lib/cuttlefish/cuttlefish","bin/cuttlefish-{{ release_version }}"}
   ]}
 ]}.

{elixir_relx_apps, []}.

{edge_relx_apps, []}.

{cloud_relx_apps,
 [{emqx_lwm2m, load},
  {emqx_auth_ldap, load},
  {emqx_auth_pgsql, load},
  {emqx_auth_redis, load},
  {emqx_auth_mongo, load},
  {emqx_lua_hook, load},
  {emqx_exhook, load},
  {emqx_exproto, load},
  {emqx_prometheus, load},
  {emqx_psk_file, load},
  {emqx_plugin_template, load},
  {observer, load},
  luerl,
  xmerl
 ]}.

{cloud_relx_overlay,
 [{template,"{{output_dir}}/../../lib/emqx_lwm2m/etc/emqx_lwm2m.conf", "etc/plugins/emqx_lwm2m.conf"},
  {template,"{{output_dir}}/../../lib/emqx_psk_file/etc/emqx_psk_file.conf", "etc/plugins/emqx_psk_file.conf"},
  {template,"{{output_dir}}/../../lib/emqx_exhook/etc/emqx_exhook.conf", "etc/plugins/emqx_exhook.conf"},
  {template,"{{output_dir}}/../../lib/emqx_exproto/etc/emqx_exproto.conf", "etc/plugins/emqx_exproto.conf"},
  {copy, "{{output_dir}}/../../lib/emqx_psk_file/etc/psk.txt", "etc/psk.txt"},
  {copy,"{{output_dir}}/../../lib/emqx_lwm2m/lwm2m_xml","etc/"}
 ]}.

{edge_relx_overlay, []}.

{edoc_opts, [{preprocess,true}]}.

{erl_opts, [warn_unused_vars,warn_shadow_vars,warn_unused_import,
            warn_obsolete_guard,no_debug_info,compressed,deterministic]}.

{overrides, [
  {add, [{erl_opts, [no_debug_info, compressed, {parse_transform, mod_vsn}, deterministic]}]}
 ,{add,[{extra_src_dirs, [{"etc", [{recursive,true}]}]}]}
]}.

{xref_checks, [undefined_function_calls,undefined_functions,locals_not_used,
               deprecated_function_calls,warnings_as_errors,
               deprecated_functions]}.
{cover_enabled, true}.
{cover_opts, [verbose]}.
{cover_export_enabled, true}.

{plugins, [
  {relup_helper, {git, "https://github.com/emqx/relup_helper", {branch, "master"}}},
  {rebar3_run, {git, "https://github.com/emqx/rebar3_run", {tag, "0.2.3"}}}
]}.

{provider_hooks, [
    {pre,  [{release, {relup_helper, gen_appups}}]},
    {post, [{release, {relup_helper, otp_vsn}},
            {release, {relup_helper, untar}}]}
]}.
